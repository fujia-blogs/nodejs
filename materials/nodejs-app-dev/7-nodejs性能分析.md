# nodejs 性能分析

1. Node.js 作为后台服务性能是⾮常关键的⼀点，⽽影响 Node.js 的性能不仅仅要考虑其本身的因素，还应该考虑所在服务器的⼀些因素。

## 代码逻辑

1. 影响性能的⼀个最⼤的原因就是在写 Node.js 代码时，没有注重性能影响问题。

### CPU 密集型计算

1. CPU 负责了程序的运⾏和业务逻辑的处理，⽽ CPU 密集型表示的主要是 CPU 承载了⽐较复杂的运算。

2. node.js 的主线程是**单线程的**，无论是主线程逻辑，还是回调处理逻辑，最终都在主线程处理，如果主线程一直在处理复杂的计算，其它请求就无法再次进来，即单个用户就可以阻塞所有用户的请求。**因此保持主线程的通畅是非常关键的。**

3. 在 Node.js 中有以下⼏种情况，会影响到主线程的运⾏，应该主动避免：

- **大的数据循环，**如：没有利用好数据流，一次性处理非常大的数组。
- **字符串处理转化**，如：加解密，字符串序列化等
- **图片、视频的计算处理**，如：图片裁剪，缩放或切割等。

4. 一些用户的复杂运算，影响到整个系统的请求处理，如果这种复杂运算占用的 CPU 时间越久，那么就会导致请求堆积，进一步导致系统处于崩溃状态无法恢复。

### 网络 I/O

1. 两种类型：

- 同步阻塞 I/O：发出⽹络请求后需要等待返回后，再处理其他计算；
- 异步非阻塞 I/O：发起⽹络 I/O 后，还可以处理其他的计算，这也是为什么 Node.js 在处理⽹络 I/O 性能较⾼的原因。

2. 对于有复杂计算的请求，如果要提升性能，应该关注什么？

- **通道复用，**减少 TCP 握手，就可以减少接口的性能，或者将某些内部服务使用 udp 来实现。
- **增加缓存，**对于相同响应的返回数据，增加缓存处理，避免不必要的计算。
- **长链接连接池，**有⼀些⽹络 I/O 是⻓链接的形式，⽐如 MySQL、Mamcached 或者 Redis，为了避免排队使⽤⻓链接的问题，可以使⽤链接池，⽽由于 Redis 和 Node.js 是单线程⾮阻塞处理，因此可以不⽤链接池。

3. ⽹络 I/O ⼀般不影响主线程逻辑，往往 **⽹络 I/O 请求的服务反⽽是瓶颈端**从⽽影响 Node.js 中涉及该⽹络服务的请求。其次⽹络 I/O 堆积较多会侧⾯影响：

- 服务器本身的网络模块问题
- node.js 性能，导致其它服务接口受影响。

### 磁盘 I/O

1. 和⽹络 I/O 相似，在⼀般情况下磁盘 I/O 是不会影响到主线程性能的

- 服务器的磁盘性能是一定的，如果在高并发情况下，磁盘 I/O 压力较大，从而导致磁盘 I/O 的服务性能下降。

2. 只有 CPU 密集计算会真正影响到 Node.js 服务性能，⽽⽹络 I/O 和磁盘 I/O 都是直接影响服务器性能，从⽽侧⾯影响到 Node.js 服务性能，⼀般这时候就需要调整服务器配置或者做⼀些队列优化⽅式来提升服务器性能。

### 集群服务

1. 集群服务的主进程也会存在瓶颈，因为所有的请求都必须经过 master 进程进⾏分发，同时接收处理 worker 进程的返回。

**tips：在⽣产环境下⼀般很难发现这类问题，不过你应该有⼀个这样的概念：⼤概在 2 万以上的并发时，master 进程会存在性能瓶颈。**

2. 对于 Node.js 后台服务，我们不仅仅要考虑其本身的性能影响，更应该考虑它对服务器资源竞争产⽣的性能影响。⽐如⽆节制地使⽤服务器的内存或者句柄，都会导致服务器的异常，⽽服务器的异常则从侧⾯影响到 Node.js 本身的性能。

### 内存限制

1. 在 32 位服务器上 Node.js 的内存限制是 0.7 G，⽽在 64 位服务器上则是 1.4 G，⽽这个限制主要是因为 Node.js 的垃圾回收线程在超过限制内存时，回收时⻓循环会⼤于 1s，从⽽会影响性能问题。

2. 现⽹我们⼀般会启⽤多个进程，如果每个进程损耗 1.4 G，那么加起来可能超出了服务器内存上限，从⽽导致服务器瘫痪。

### 句柄限制

1. 句柄，简单理解就是一个**ID 索引**，通过这个索引可以访问到其它资源，如：文件句柄，网络 I/O 操作句柄等，**一般服务器句柄都有上限。**

当 node.js 没有控制好句柄，如：无限的打开文件并未关闭，就会出现句柄泄漏问题，⽽这样会导致服务器异常，从⽽影响 Node.js 服务。
