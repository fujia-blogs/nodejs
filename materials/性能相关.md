# node.js 性能

1，Node.js 作为后台服务性能是⾮常关键的⼀点，⽽影响 Node.js 的性能不仅仅要考虑其本身的因素，还应该考虑所在服务器的⼀些因素

2，只有 CPU 密集计算会真正影响到 Node.js 服务性能，⽽⽹络 I/O 和磁盘 I/O 都是直接影响服务器性能，从⽽侧⾯影响到 Node.js 服务性能，⼀般这时候就需要调整服务器配置或者做⼀些队列优化⽅式来提升服务器性能

## 性能因素分析

### CPU 密集型计算

CPU 负责了程序的运⾏和业务逻辑的处理，⽽ CPU 密集型表示的主要是 CPU 承载了⽐较复杂的运算

1，在 node.js 中**主线程是单线程的**，无论主线程逻辑，还是回调处理逻辑**最终都在主线程处理**，如果该线程一直在处理复杂的计算，其它请求就无法再次进来，即单个用户就可阻塞所有用户的请求，**因此保持主线程的通畅是非常关键的**

2，下面几种情况会影响主线程的运行，**应主动避免**：

- 大的数据循环，如：没有利用好数据流，一次性处理非常大的数组
- 字符串处理转化，如：加解密，字符串序列化等
- 图片，视频的计算处理，如：图片进行裁切，缩放或者切割等

因为某些⽤户的复杂运算，⽽影响到整个系统的请求处理，如果这种复杂运算占⽤的 CPU 时间越久，那么就会导致请求堆积，⽽这就会进⼀步导致系统处于崩溃状态⽆法恢复

3，解决方案

- 将 CPU 密集型计算使用其它进程来处理
- 通道复用，减少 TCP 握手，就可以提升该接口的性能，或将某些内部服务使用 udp 来实现
- 增加缓存，对于相同响应的返回数据，增加缓存处理，避免不必要的计算
- 长链接连接池，有⼀些⽹络 I/O 是⻓链接的形式，⽐如 MySQL、Mamcached 或者 Redis，为了避免排队使⽤⻓链接的问题，可以使⽤链接池，⽽由于 Redis 和 Node.js 是单线程⾮阻塞处理，因此可以不⽤链接池

## 网络 I/O

1，⽹络 I/O ⼀般不影响主线程逻辑，往往⽹络 I/O 请求的服务反⽽是瓶颈端，从⽽影响 Node.js 中涉及该⽹络服务的请求。其次⽹络 I/O 堆积较多会侧⾯影响：

- 服务器本身的网络模块问题
- node.js 性能，导致其它服务接口受影响

## 磁盘 I/O

1，和⽹络 I/O 相似，在⼀般情况下磁盘 I/O 是不会影响到主线程性能的

2，服务器的磁盘性能是⼀定的，如果在⾼并发情况下，磁盘 I/O 压⼒较⼤，从⽽导致磁盘 I/O 的服务性能下降

3，在实际开发过程中，最常⻅的磁盘 I/O 场景，那就是**⽇志模块**，因为⽇志是需要写⽂件，从⽽会有频繁的⽇志写⼊。和⽹络 I/O 相似，磁盘 I/O 也会从侧⾯的影响机器性能，导致 Node.js 服务性能受影响。

## 多进程 cluster 模式

1，大概在 2w 以上的并发时，master 进程会存在性能瓶颈

2，对于 Node.js 后台服务，我们不仅仅要考虑其本身的性能影响，更应该考虑它对服务器资源竞争产⽣的性能影响。⽐如⽆节制地使⽤服务器的内存或者句柄，都会导致服务器的异常，⽽服务器的异常则从侧⾯影响到 Node.js 本身的性能。

## 内存限制

1，32 位服务器上 node.js 的内存限制是 0.7g，64 位是 1.4g

2，这个限制主要因为 node.js 的垃圾回收线程在超过限制内存时，回收时长循环会大于 1s， 从而影响性能问题

3，现⽹我们⼀般会启⽤多个进程，如果每个进程损耗 1.4 G，那么加起来可能超出了服务器内存上限，从⽽导致服务器瘫痪。其次如果内存不会超出服务器上限，⽽是在达到⼀定上限时，也就是我们上⾯说的 0.7 G 和 1.4G，会导致服务器重启，从⽽会导致接⼝请求失败的问题。

## 句柄限制

1，句柄可以简单理解为一个 ID 索引，通过这个索引可访问到其它资源，比如说：文件句柄，网络 I/O 操作句柄等，**一般服务器句柄都有上限**

- 当 node.js 没有控制好句柄，⽐如说⽆限的打开⽂件并未关闭，就会出现句柄泄漏问题，⽽这样会导致服务器异常，从⽽影响 Node.js 服务
